#!groovy

properties([
    parameters([
        booleanParam(name: 'RELEASE', description: 'Upload the new binaries to s3', defaultValue: false),
    ]),
    buildDiscarder(logRotator(numToKeepStr: '5', artifactNumToKeepStr: '15')),
    disableConcurrentBuilds(),
])

try {
    timeout(time: 30, unit: 'MINUTES') {
        node('nami_debian_agent') {
            env.JOB_WORKSPACE = "${env.HOME}/workspace/${env.JOB_NAME}/${env.BUILD_ID}"
            ws(env.JOB_WORKSPACE) {
                ansiColor {
                    def version = ""
                    def binariesOutput = "${pwd()}/bitnami-tui-binaries"
                    def originalBinaries = [
                        windows: "bitnami-tui-windows-x64.exe",
                        linux: "bitnami-tui-linux-x64.run",
                        osx: "bitnami-tui-osx-x64",
                    ]
                    dir('bitnami-tui') {
                        stage('Initialize') {
                            checkout scm
                            version = readFile(file: 'VERSION').trim()
                            sh "mkdir -p '${binariesOutput}'"
                        }
                        def binariesWithVersion = [
                            windows: "bitnami-tui-${version}-windows-x64.exe",
                            linux: "bitnami-tui-${version}-linux-x64.run",
                            osx: "bitnami-tui-${version}-osx-x64",
                        ]
                        stage('Build') {
                            withGcloudDockerCredentials {
                                withBazel([
                                    dockerExtraOpts: "-v '${binariesOutput}:/bitnami-tui-binaries:rw'",
                                ]) {
                                    sh """
                                        bazel build //...
                                        ls -1d bazel-bin/bitnami-tui-* | grep -v runfiles | xargs -I % cp -pfv % /bitnami-tui-binaries
                                    """
                                }
                            }
                        }
                        stage('Test') {
                            def linuxBinary = "${binariesOutput}/${originalBinaries.linux}"
                            sh '''
                                sudo apt-get update
                                sudo apt-get install -y expect tmux
                            '''
                            dir('tests') {
                                timeout(120) {
                                    sh """
                                        tmux new-session -s btui_test -d -x 100 -y 100 "./test.sh '${linuxBinary}' |& tee /tmp/btui_tests_output"
                                        while [ ! -f /tmp/btui_exit_code ]; do sleep 5; done
                                        cat /tmp/btui_tests_output
                                        exit \$(cat /tmp/btui_exit_code)
                                    """
                                }
                            }
                        }
                        stage('Release') {
                            dir(binariesOutput) {
                                // Only copy the target files
                                sh """
                                    mkdir '${version}'
                                """
                                for (platform in originalBinaries.keySet()) {
                                    sh "mv '${originalBinaries[platform]}' '${version}/${binariesWithVersion[platform]}'"
                                }
                                archiveArtifacts artifacts: "${version}/*", fingerprint: true

                                if (params.RELEASE) {
                                    withCredentials([
                                        usernamePassword(credentialsId: 'ami-credentials-iam', usernameVariable: 'ACCESS_KEY', passwordVariable: 'SECRET_KEY'),
                                    ]) {
                                        for (platform in binaries.keySet()) {
                                          sh """
                                              s3cmd put --access_key=ACCESS_KEY --secret_key=SECRET_KEY --recursive '${version}/*' s3://bitnami-autobuild-ondemand/installers/stable/
                                          """
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }
} catch (e) {
    // slackSend() ... etc
    throw e
}
